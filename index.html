<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VG TV</title>
    <link rel="icon" href="https://raw.githubusercontent.com/VGLiveTV/vgtv/refs/heads/main/fav.png">
    
    <style>
        /* CHANGED THEME COLOR TO RED (#e50914) */
        :root { --bg: #0f172a; --card: #1e293b; --accent: #e50914; --text: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* Navbar */
        .nav { padding: 15px; background: #111; border-bottom: 2px solid var(--accent); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .nav-logo { height: 35px; margin-right: 10px; object-fit: contain; }
        
        /* Server Toggles */
        .server-toggles { display: flex; gap: 5px; margin-right: 5px; }
        .server-btn { padding: 6px 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .server-btn:hover { background: #444; }
        .server-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: bold; }

        /* Inputs & Selects */
        input[type="text"], select { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #000; color: #fff; outline: none; font-size: 13px; }
        input[type="text"] { flex: 1; min-width: 150px; }
        select { cursor: pointer; min-width: 120px; }
        select:focus, input:focus { border-color: var(--accent); }

        .btn { padding: 8px 12px; background: var(--accent); color: #fff; border-radius: 4px; font-weight: bold; cursor: pointer; border: none; font-size: 13px; white-space: nowrap; text-decoration: none; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        
        /* Grid */
        .grid { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: var(--card); padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .card img { width: 60px; height: 60px; object-fit: contain; background: #fff; border-radius: 6px; padding: 4px; margin-bottom: 8px; }
        .card div { font-size: 12px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: bold; }
        .card-sub { color: #888; font-size: 10px !important; margin-top: 3px; font-weight: bold !important; }
        .card-lang { font-size: 10px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: bold; }
    </style>
</head>
<body>

    <div class="nav">
        <img src="https://raw.githubusercontent.com/VGLiveTV/vgtv/refs/heads/main/logo.png" alt="VG TV Logo" class="nav-logo">
        
        <div class="server-toggles">
            <button class="server-btn active" id="btn-srv1" onclick="switchServer(1)">Server 1</button>
            <button class="server-btn" id="btn-srv2" onclick="switchServer(2)">Server 2</button>
        </div>

        <input type="text" id="search" placeholder="Search Channel...">
        
        <select id="catFilter">
            <option value="">All Categories</option>
        </select>
        <select id="langFilter">
            <option value="">All Languages</option>
        </select>
        
        <button class="btn" onclick="fetchBothServers()">REFRESH</button>
    </div>

    <div id="grid" class="grid">
        <div style="grid-column:1/-1; text-align:center; color:#555; margin-top:50px;">
            Loading Channels...
        </div>
    </div>

    <script>
        const API_URL_1 = "https://allrounderid.pages.dev/api/jiotv.json";
        const API_URL_2 = "https://allrounderid.pages.dev/api/jiotv2.json";
        
        let db1 = [];
        let db2 = [];
        let activeDb = []; 

        // 1. Fetch BOTH APIs on load
        async function fetchBothServers() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; margin-top:50px;">Fetching Servers...</div>';
            
            try {
                try {
                    const res1 = await fetch(API_URL_1);
                    if (res1.ok) db1 = await res1.json();
                } catch(e) { console.warn("Server 1 failed to load"); }

                try {
                    const res2 = await fetch(API_URL_2);
                    if (res2.ok) db2 = await res2.json();
                } catch(e) { console.warn("Server 2 failed to load"); }

                // Sort both alphabetically
                db1.sort((a, b) => (a.channel_name || "").localeCompare(b.channel_name || ""));
                db2.sort((a, b) => (a.channel_name || "").localeCompare(b.channel_name || ""));
                
                // Default to Server 1 on startup
                switchServer(1);
            } catch (err) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#ef4444; margin-top:50px;">Failed to Load Channels.<br>Check Internet Connection.</div>`;
                console.error(err);
            }
        }

        // Switch between Server 1 and Server 2
        function switchServer(num) {
            activeDb = (num === 1) ? db1 : db2;
            
            document.getElementById('btn-srv1').classList.toggle('active', num === 1);
            document.getElementById('btn-srv2').classList.toggle('active', num === 2);
            
            document.getElementById('search').value = "";
            
            updateDropdowns("", ""); 
            applyFilters();
        }

        // 2. Filter Logic
        const searchInput = document.getElementById('search');
        const catFilter = document.getElementById('catFilter');
        const langFilter = document.getElementById('langFilter');

        function applyFilters() {
            const t = searchInput.value.toLowerCase();
            const selectedCat = catFilter.value;
            const selectedLang = langFilter.value;

            const filtered = activeDb.filter(c => {
                const name = (c.channel_name || "").toLowerCase();
                const genre = (c.channel_genre || "Others"); 
                const lang = (c.channel_language || c.language || c.lang || "Others");

                const matchesSearch = name.includes(t) || genre.toLowerCase().includes(t) || lang.toLowerCase().includes(t);
                const matchesCat = selectedCat === "" || genre === selectedCat;
                const matchesLang = selectedLang === "" || lang === selectedLang;

                return matchesSearch && matchesCat && matchesLang;
            });

            render(filtered);
            updateDropdowns(selectedCat, selectedLang); 
        }

        searchInput.oninput = applyFilters;
        catFilter.onchange = applyFilters;
        langFilter.onchange = applyFilters;

        // 3. Smart Dropdowns 
        function updateDropdowns(currentCat, currentLang) {
            // --- CATEGORY COUNTS ---
            const catBaseList = activeDb.filter(c => {
                const lang = (c.channel_language || c.language || c.lang || "Others");
                return currentLang ? lang === currentLang : true; 
            });

            const catCounts = {};
            catBaseList.forEach(c => {
                const cat = c.channel_genre || "Others";
                catCounts[cat] = (catCounts[cat] || 0) + 1;
            });
            const categories = Object.keys(catCounts).sort();
            
            let catHTML = `<option value="">All Categories (${catBaseList.length})</option>`;
            categories.forEach(cat => {
                 const isSelected = cat === currentCat ? 'selected' : '';
                 catHTML += `<option value="${cat}" ${isSelected}>${cat} (${catCounts[cat]})</option>`;
            });
            catFilter.innerHTML = catHTML;

            // --- LANGUAGE COUNTS ---
            const langBaseList = activeDb.filter(c => {
                const cat = c.channel_genre || "Others";
                return currentCat ? cat === currentCat : true;
            });

            const langCounts = {};
            langBaseList.forEach(c => {
                const lang = (c.channel_language || c.language || c.lang || "Others");
                langCounts[lang] = (langCounts[lang] || 0) + 1;
            });
            const languages = Object.keys(langCounts).sort();

            let langHTML = `<option value="">All Languages (${langBaseList.length})</option>`;
            languages.forEach(lang => {
                const isSelected = lang === currentLang ? 'selected' : '';
                langHTML += `<option value="${lang}" ${isSelected}>${lang} (${langCounts[lang]})</option>`;
            });
            langFilter.innerHTML = langHTML;
        }

        // 4. Render Grid
        function render(data) {
            const g = document.getElementById('grid');
            if(data.length === 0) {
                g.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#555;">No Channels Found in this Server</div>';
                return;
            }
            g.innerHTML = data.map(c => {
                const lang = c.channel_language || c.language || c.lang || "";
                return `
                <div class="card" onclick='playInNewTab(${JSON.stringify(c).replace(/'/g, "&apos;")})'>
                    <img src="${c.channel_logo}" onerror="this.src='https://via.placeholder.com/60?text=TV'">
                    <div>${c.channel_name}</div>
                    <div class="card-sub">${c.channel_genre || 'Channel'}</div>
                    <div class="card-lang">${lang}</div>
                </div>
            `}).join('');
        }

        // 5. Generate & Open Player
        function playInNewTab(c) {
            const name = c.channel_name || "VG Player";
            const url = c.channel_url || "";
            const kid = (c.keyId && c.keyId !== "Null") ? c.keyId : "";
            const key = (c.key && c.key !== "Null") ? c.key : "";
            const cookie = c.cookie || "";

            const safeKid = JSON.stringify(kid);
            const safeKey = JSON.stringify(key);
            const safeCookie = JSON.stringify(cookie);
            const safeUrl = JSON.stringify(url);

            const playerCode = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${name}</title>
  <link rel="icon" href="https://raw.githubusercontent.com/VGLiveTV/vgtv/refs/heads/main/fav.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"><\/script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
    .shaka-video-container { position: absolute; inset: 0; width: 100%; height: 100%; }
    video { width: 100%; height: 100%; background: #000; object-fit: contain; }
    .shaka-spinner-container { display: none !important; }
  </style>
</head>
<body>
  <div class="shaka-video-container" data-shaka-player>
    <video autoplay playsinline preload="metadata" id="video"></video>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        shaka.polyfill.installAll();
        if (!shaka.Player.isBrowserSupported()) {
            alert('Browser not supported');
            return;
        }

        const video = document.getElementById('video');
        const player = new shaka.Player(video);
        const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

        ui.configure({
            controlPanelElements: ['play_pause','time_and_duration','mute','volume','spacer','language','captions','picture_in_picture','quality','fullscreen'],
            // Updated Player Progress Bar to Red
            seekBarColors: { base: 'rgba(255,255,255,0.3)', buffered: 'rgba(229, 9, 20, 0.5)', played: '#e50914' }
        });

        const kid = ${safeKid};
        const key = ${safeKey};
        let cookieHeader = ${safeCookie};
        let streamUrl = ${safeUrl};

        let drmConfig = { clearKeys: {} };
        if(kid && key) {
            drmConfig.clearKeys[kid] = key;
        }

        try {
            const response = await fetch('https://allrounderid.pages.dev/api/jiotv2.json');
            const data = await response.json();
            const channel = data.find(ch => ch.channel_name === "DD Sports");
            if (channel && channel.cookie) { cookieHeader = channel.cookie; }
        } catch (e) {}

        let backupCookie = null;
        let usingBackupCookie = false;

        async function fetchBackupCookie() {
            if (backupCookie) return backupCookie;
            const res = await fetch('https://crickettv.site/api/cookie.json');
            const data = await res.json();
            backupCookie = data.cookie;
            return backupCookie;
        }

        async function switchToBackupCookie() {
            if (usingBackupCookie) return;
            usingBackupCookie = true;
            cookieHeader = await fetchBackupCookie();
            try {
                await player.unload();
                await player.load(streamUrl);
                video.play();
            } catch (e) {}
        }

        player.configure({ drm: drmConfig });

        player.getNetworkingEngine().registerRequestFilter((type, request) => {
            request.headers['Referer'] = 'https://www.jiotv.com/';
            request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
            if(cookieHeader) request.headers['Cookie'] = cookieHeader;

            if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) && request.uris[0] && !request.uris[0].includes('__hdnea=')) {
                const sep = request.uris[0].includes('?') ? '&' : '?';
                request.uris[0] += sep + cookieHeader;
            }
        });

        player.addEventListener('error', async (event) => {
            const err = event.detail;
            if (!usingBackupCookie && (err.code === 401 || err.code === 403 || err.code === shaka.util.Error.Code.BAD_HTTP_STATUS || err.code === shaka.util.Error.Code.MANIFEST_UNAVAILABLE)) {
                await switchToBackupCookie();
            }
        });

        try {
            await player.load(streamUrl);
            video.play();
        } catch (e) { console.error(e); }
    });
  <\/script>
</body>
</html>`;

            const blob = new Blob([playerCode], { type: 'text/html' });
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        }

        // Initialize App
        fetchBothServers();
    </script>
</body>
</html>
